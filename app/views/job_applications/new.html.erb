<%= provide(:title, 'New Job Applications') %>

<div class="container mt-5">
  <div class="row">
    <div class="col-12">
      <div class="companies d-flex flex-column justify-content-start mb-4">
        <%# Dynamically load the company logos based on selected jobs %>
        <p class="mb-1">Current applications:</p>

        <div class="company-apply-summary bg-body-secondary p-2 d-flex">
          <%# TODO: Update company logos once pulling from TrueUp (clearbit) %>
          <% @selected_jobs.each_with_index do |job, index| %>
            <div><%= index + 1 %></div>
            <%= link_to image_tag('company_logo_default.jpeg', class: 'img-fluid'), '#', class: 'apply-company-logo mr-3' %>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <%# Iterate over each selected job %>
  <div class="all-application-forms" data-controller="job-application-forms response-input">
    <% @job_applications.each_with_index do |job, index| %>
      <details class="application-form bg-body-secondary mb-3" open>
        <summary class="pb-1" style="display: block"><h2><%= index + 1 %>. <%= job.first.company.company_name %> - <%= job.first.job_title %></h2></summary>
        <%= simple_form_for job, html: { class: 'needs-validation', 'data-controller': 'application-form', 'data-application-form-target': 'form', novalidate: true } do |f| %>

          <%# Dynamically create form elements based on application_criteria %>
          <%# Convert to simple_fields_for application_responses. Then use those to create the input fields below. %>
          <% job.last.application_responses.each_with_index do |response, response_index| %>

            <% if response_index == 0 %>
              <details class="core-details bg-light" open>
              <summary class="mb-2 bolded">Core details:</summary>
            <% end %>

            <%= f.simple_fields_for response do |ff| %>
              <div class="form-group row">
                <label  class="apply-label col-sm-2 col-form-label text-center mb-3 rounded-pill" for=""><%= response.field_name.humanize %></label>
                <div class="col-sm-10 mr-2">
                  <%= ff.input :field_value , label_html: { class: "d-none"}, input_html: { class: "rounded-pill", data: { label: response.field_name, response_input_target: "input", action: "keyup->response-input#handleChange change->response-input#handleChange"} } %>
                </div>
              </div>
            <% end %>

            <% if response.field_name == "resume" %> <%# This is the last CORE APPLICATION FIELD%>
              </details>
              <details class="core-details bg-light" open> <%# Add a new details tag for additional details %>
                <summary class="mb-2 bolded">Additional details:</summary>
              </details> <%# Close the additional details tag %>
            <% end %>
          <% end %>
          <%# TODO: Map data types here.s %>
          <%# TODO: Handle File uploads %>


          <div class="d-flex justify-content-end align-items-end">
            <%= f.submit 'Submit this application', class: 'btn btn-cheddar-secondary', 'data-action': 'click->application-form#submitForm' %>
          </div>
        <% end %>
        </details>
    <% end %>
    <div class="d-flex justify-content-end align-items-center me-3 pe-1 pt-3">
      <h5 class="me-4 mb-0">Apply to all applications at once:</h5>
      <button class="btn btn-apply" data-action="click->all-application-forms#submitAllForms">Submit All</button>
    </div>
  </div>
</div>

<%# job.last.application_responses[4].field_name %>
